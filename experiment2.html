<!DOCTYPE html>
<html>
<body>
<p id="timer" align="center"></p>
<div style="width: 100%; overflow: hidden;">
    <p>第一阶段数字开头成语</p>
    <ul id="s1_list">
    </ul>
    <p>第二阶段非数字开头成语</p>
    <ul id="s2_list">
    </ul>
</div>
<div id="start">
  <p>本实验分为两个阶段，时间共八分钟</p>
  <p>第一阶段四分钟，在输入框里面输入第一个字是数字的成语</p>
  <p>第一阶段四分钟，在输入框里面输入第一个字是非数字的成语</p>
  <p>实验期间不要刷新页面，否则结果会丢失</p>
  <p>点击开始按钮开始实验</p>
  <p>结束时请按保存结果按钮</p>
  请输入用户编号:
  <input  id="user_id" type="text"></input>
  <button id="start_button"  onclick="onStart()">开始输入成语</button>
</div>
<div id="stage1"> </div>
<div id="stage2"> </div>
<div id="save"> </div>

<script>

    console.log("init called");

    // 刷新页面时提出警告
    window.onBeforeUnload = function () { return false;};
    document.onselectstart = function () { return false;};



    // 全局数据结构
    // 输入成语的时间，单位秒
    let s1_input_time_seconds = 20;
    // 输入速度测试的时间，单位秒
    let s2_input_time_seconds = 20;
    // 实验开始时间
    let exp_start_time;
    // 速度测试开始时间
    let speed_start_time;

    // 用来存放最后需要输出的结构
    let test_object = new Map();

    // 页面打开时间
    test_object['page_start_time'] = new Date();
    test_object['type'] = '实验二';
    // 测速结果数据
    test_object['speed'] = new Map();
    // 实验结果数据
    test_object['exp'] = new Map();
    // 数字开头成语列表
    test_object['exp']['s1_list'] = [];
    // 非数字开头成语列表
    test_object['exp']['s2_list'] = [];


    // 开始测试，并隐藏开始按钮
    function onStart() {
        exp_start_time = new Date();
        test_object['exp']['start_time'] = exp_start_time;

        // 读取用户id
        let user_id = document.getElementById("user_id").value;

        // 防止空id
        if (user_id.length < 1) {
            return;
        }

        test_object['user_id'] = user_id;


        // 隐藏 start_button
        removeElementById("start");

        // 显示输入button
        displayStage1();
    }

    function displayStage1() {
        console.log("displayStage1 called");
        let innerText = "输入一个成语，然后回车，数字开头的成语会显示，非数字开头的成语会被忽略";
        let p = createElementP(innerText);

        let s1_input_box = createElementInputText("s1_input_box");

        let s1_input_btn = createElementButton("s1_input_btn", onStage1Input, "提交");

        // 把chengyu_text元素的回车键变成chengyu_button元素的鼠标点击事件
        s1_input_box.addEventListener("keyup", function(ev) {
            console.log("event called");
            ev.preventDefault();
            if (ev.keyCode === 13) {
                s1_input_btn.click();
            }
        });

        document.getElementById('stage1').insertAdjacentElement("beforeend", p);
        document.getElementById('stage1').insertAdjacentElement("beforeend", s1_input_box);
        document.getElementById('stage1').insertAdjacentElement("beforeend", s1_input_btn);

        let onStage1Timeout = function() {
            test_object['exp']['stage1_end_time'] = new Date();
            removeElementById("stage1");
            displayStage2()
        };

        // 设置倒计时，时间到了执行 onTimeout
        createCountdownTimer(s1_input_time_seconds, onStage1Timeout);
    }


    function onStage1Input() {
        console.log("onStage1Input called");
        let now = new Date();
        console.log("elapsed seconds="+(now-exp_start_time)/1000);

        if ((now -exp_start_time) > 480*1000) {
            console.log("time's up");
            return;
        }
        let t = document.getElementById("s1_input_box");
        let text = t.value;
        if (text.length < 4) {
            console.log("text="+ text + ", text.length < 4");
            return;
        }
        let found = isQualifiedChengYu(text);
        if (!found) {
            // 第一阶段，非数字开头的成语被忽略
            return;
        }

        let l = document.createElement("li");
        l.innerText = text;

        let list = document.getElementById("s1_list");
        let sample = [];
        sample.push(text);
        sample.push(now);
        test_object['exp']['s1_list'].push(sample);
        list.insertAdjacentElement("beforeend", l);
        t.value = "";
        t.focus();
    }

    function displayStage2() {
        console.log("displayStage2 called");
        let innerText = "输入一个成语，然后回车，非数字开头的成语会显示，数字开头的成语会被忽略";
        let p = createElementP(innerText);

        let s2_input_box = createElementInputText("s2_input_box");

        let s2_input_btn = createElementButton("s2_input_btn", onStage2Input, "提交");

        // 把input text元素的回车键变成button元素的鼠标点击事件
        s2_input_box.addEventListener("keyup", function(ev) {
            console.log("event called");
            ev.preventDefault();
            if (ev.keyCode === 13) {
                s2_input_btn.click();
            }
        });

        document.getElementById('stage2').insertAdjacentElement("beforeend", p);
        document.getElementById('stage2').insertAdjacentElement("beforeend", s2_input_box);
        document.getElementById('stage2').insertAdjacentElement("beforeend", s2_input_btn);

        let onStage2Timeout = function() {
            test_object['exp']['stage1_end_time'] = new Date();
            removeElementById("stage2");
            displaySave()
        };

        // 设置倒计时，时间到了执行 onTimeout
        createCountdownTimer(s2_input_time_seconds, onStage2Timeout);
    }

    function onStage2Input() {
        console.log("onStage2Input called");
        let now = new Date();
        console.log("elapsed seconds="+(now-exp_start_time)/1000);

        if ((now -exp_start_time) > 480*1000) {
            console.log("time's up");
            return;
        }
        let t = document.getElementById("s2_input_box");
        let text = t.value;
        if (text.length < 4) {
            console.log("text="+ text + ", text.length < 4");
            return;
        }
        let found = isQualifiedChengYu(text);
        if (found) {
            // 第二阶段，数字开头的成语被忽略
            return;
        }

        let l = document.createElement("li");
        l.innerText = text;

        let list = document.getElementById("s2_list");
        let sample = [];
        sample.push(text);
        sample.push(now);
        test_object['exp']['s2_list'].push(sample);
        list.insertAdjacentElement("beforeend", l);
        t.value = "";
        t.focus();
    }

    function displaySave() {
        displayButton("save", onSave, "保存实验结果");
    }


    function onSave() {
        let filename = test_object["user_id"];
        filename += ".stage1.txt";
        console.log("onSave1 called filename="+filename);

        let text = JSON.stringify(test_object);
        download(filename, text);

        // 一次实验完成，重新刷新页面
        window.location.reload(false);
    }

    // 工具类，完成一个功能，和具体的业务流程无关
    function download(filename, text) {
        let pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        pom.setAttribute('download', filename);

        if (document.createEvent) {
            let event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            pom.dispatchEvent(event);
        }
        else {
            pom.click();
        }
    }

    // 在id=div_id 的div的最后添加一个button
    function displayButton(divId, onClick, text) {
        let buttonId = divId+"_button";
        let button = createElementButton(buttonId, onClick, text);
        document.getElementById(divId).insertAdjacentElement("beforeend", button);
    }

    function removeElementById(elem) {
        let n = document.getElementById(elem);
        n.parentNode.removeChild(n);
    }

    function clearElementValue(elem) {
        let n = document.getElementById(elem);
        n.value = ""
    }

    function createElementP(innerText) {
        let p = document.createElement("p");
        p.innerText = innerText;
        return p;
    }

    function createElementInputText(inputId) {
        let text = document.createElement("input");
        text.id = inputId;
        text.type = "text";
        return text;
    }

    function createElementButton(buttonId, onClick, text) {
        let button = document.createElement("button");
        button.id = buttonId;
        button.innerText = text;
        button.onclick = onClick;
        return button;
    }

    // 设置一个Countdown Timer定时任务
    // 当 timeoutSeconds 过去之后，执行回调函数 onTimeout
    function createCountdownTimer(timeoutSeconds, onTimeout) {
        // 计算得到倒计时停止时间
        let now = new Date();
        let timeoutDate = now.getTime()+timeoutSeconds*1000;
        let countDownDate = new Date(timeoutDate).getTime();

        // Update the count down every 1 second
        let x = setInterval(function() {

            // Get todays date and time
            let now = new Date().getTime();

            // Find the distance between now and the count down date
            let distance = countDownDate - now;

            // Time calculations for days, hours, minutes and seconds
            let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the result in the element with id="timer"
            document.getElementById("timer").innerHTML = minutes + "m " + seconds + "s ";

            // If the count down is finished, write some text
            if (distance < 0) {
                clearInterval(x);
                document.getElementById("timer").innerHTML = "";
                onTimeout();
            }
        }, 1000);
    }

    function isQualifiedChengYu(text) {
        return chengyuStartsWithNumber(text);
    }

    let num_char = ["零", "一", "二", "三", "四", "五", "六", "七", "八",
        "九", "十", "百", "千", "万", "亿"];
    function chengyuStartsWithNumber(text) {
        let c = text.charAt(0);
        let found = false;
        for (let j = 0; j < num_char.length; j++) {
            // console.log("c="+c+", num_char="+num_char[j]);
            if (c === num_char[j]) {
                found = true;
                console.log(c + " found");
                break;
            }
        }
        return found;
    }

    function chengyuContainsNumber(text) {
        let found = false;
        for (let i = 0; i < text.length; ++i) {
            let c = text.charAt(i);
            for (let j = 0; j < num_char.length; j++) {
                // console.log("c="+c+", num_char="+num_char[j]);
                if (c === num_char[j]) {
                    found = true;
                    console.log(c + " found");
                    break;
                }
            }
        }
        return found;
    }


</script>

</body>
</html>
