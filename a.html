<!DOCTYPE html>
<html>
  <body>
    <p id="timer" align="center"></p>
    <div style="width: 100%; overflow: hidden;">
          <div id="left"; style="width: 50%; float: left;">
            <ul id="left_list">
            </ul>
          </div>
          <div id="right"; style="margin-left: 50%;">
            <ul id="right_list">
            </ul>
          </div>
    </div>
    <div id="start">
      <p>点击开始按钮开始实验</p>
      <p>时间八分钟</p>
      <p>实验期间不要刷新页面，否则结果会丢失</p>
      <p>结束时请按保存结果按钮</p>
      输入用户名: 
      <input  id="user_name" type="text"></>
      <button id="start_button"  onclick="onStart()">开始</button>
    </div>

    <div id="save">
<!--
    <button id="save" onclick="onSave()">保存</button>
-->
    </div>
    <div id="input">
<!--
    <p>输入一个成语，然后回车:</p>
    <input  id="chengyu_text" type="text">
    <button id="chengyu_button"  onclick="onChengyuInput()">提交</button>
-->
    </div>

<script>
console.log("init called");

// 刷新页面是提出警告
window.onbeforeunload = function () {return false;}


// 全局数据结构
var start_time;

// 用来存放最后需要输出的结构
var test_object = new Map();
test_object['page_start_time'] = new Date();
test_object['left_list'] = new Array();
test_object['right_list'] = new Array();

// 开始测试，并隐藏开始按钮
function onStart() {
  start_time = new Date();
  test_object['test_start_time'] = start_time;
  var t = document.getElementById("user_name");
  test_object['user_name'] = t.value

  var countDownDate = new Date(start_time.getTime()+10000).getTime();
  //var countDownDate = new Date(start_time.getTime()+480000).getTime();

  // Update the count down every 1 second
  var x = setInterval(function() {

    // Get todays date and time
    var now = new Date().getTime();

    // Find the distance between now and the count down date
    var distance = countDownDate - now;

    // Time calculations for days, hours, minutes and seconds
    //var days = Math.floor(distance / (1000 * 60 * 60 * 24));
    //var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = Math.floor((distance % (1000 * 60)) / 1000);

    // Display the result in the element with id="timer"
    document.getElementById("timer").innerHTML = minutes + "m " + seconds + "s ";

    // If the count down is finished, write some text 
    if (distance < 0) {
      clearInterval(x);
      document.getElementById("timer").innerHTML = "Time's Up Now";
      test_object['test_end_time'] = new Date();
      removeChengyuInput();
      displaySave();
    }
  }, 1000);
   // 隐藏 start_button
  b = document.getElementById("start")
  b.parentNode.removeChild(b);

  // 显示输入button
  displayChengyuInput();
}

function removeChengyuInput() {
  b = document.getElementById("input")
  b.parentNode.removeChild(b);
}

function displayChengyuInput() {
  console.log("displayChengyuInput called");
  p = document.createElement("p");
  p.innerText = "输入一个成语，然后回车:";

  chengyu_text = document.createElement("input");
  chengyu_text.id = "chengyu_text";
  chengyu_text.type = "text";

  chengyu_button = document.createElement("button");
  chengyu_button.id = "chengyu_button";
  chengyu_button.innerText = "提交";
  chengyu_button.onclick = onChengyuInput;
  //chengyu_button.addEventListener("click", onChengyuInput());

  // 把chengyu_text元素的回车键变成chengyu_button元素的鼠标点击事件
  // var chengyu_text = document.getElementById("chengyu_text");
  chengyu_text.addEventListener("keyup", function(ev) {
      console.log("event called");
      ev.preventDefault();
      if (ev.keyCode === 13) {
        //document.getElementById("chengyu_button").click();
        chengyu_button.click();
      }
    });

  document.getElementById('input').insertAdjacentElement("beforeend", p);
  document.getElementById('input').insertAdjacentElement("beforeend", chengyu_text);
  document.getElementById('input').insertAdjacentElement("beforeend", chengyu_button);
}

var num_char = ["零", "一", "二", "三", "四", "五", "六", "七", "八",
"九", "十", "百", "千", "万", "亿"];

function onChengyuInput() {
  console.log("onChengyuInput called");
  now = new Date();
  console.log("elapsed seconds="+(now-start_time)/1000);

  if ((now -start_time) > 480*1000) {
    console.log("time's up");
    return;
  }
  var t = document.getElementById("chengyu_text");
  text = t.value;
  c = text.charAt(0);
  var found = false;
  for (var j = 0; j < num_char.length; j++) {
    // console.log("c="+c+", num_char="+num_char[j]);
    if (c == num_char[j]) {
      found = true;
      console.log(c + " found");
      break;
    }
  }
  l = document.createElement("li");
  l.innerText = text
    var list
    if (found) {
      test_object['left_list'].push(text);
      // console.log(text + " find num");
      list = document.getElementById("left_list");
    } else {
      test_object['right_list'].push(text);
      // console.log(text + " not find num");
      list = document.getElementById("right_list");
    }
  list.insertAdjacentElement("beforeend", l);
  t.value = "";
  t.focus();
}

function displaySave() {
  save_button = document.createElement("button");
  save_button.id = "save_button";
  save_button.innerText = "保存";
  save_button.onclick = onSave;
  document.getElementById('save').insertAdjacentElement("beforeend", save_button);
}

function onSave() {
  var filename = new Date().toString() + ".txt";
  console.log("onSave called filename="+filename);

  var chengyus = [];
  var lis = document.getElementById("left_list").getElementsByTagName("li");
  for (i = 0; i < lis.length; ++i) {
    chengyus.push(lis[i].innerText);
  }
  lis = document.getElementById("right_list").getElementsByTagName("li");
  for (i = 0; i < lis.length; ++i) {
    chengyus.push(lis[i].innerText);
  }
  text = JSON.stringify(test_object);
  download(filename, text);
}

function download(filename, text) {
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    pom.setAttribute('download', filename);

    if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
    }
    else {
        pom.click();
    }
}

    </script>

  </body>
</html>
